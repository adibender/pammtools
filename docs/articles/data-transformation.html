<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Transformation • pammtools</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">pammtools</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/baseline.html">Baseline Hazard</a>
    </li>
    <li>
      <a href="../articles/basics.html">Basic Modeling </a>
    </li>
    <li>
      <a href="../articles/convenience.html">Convenience functions for post-processing PAMs</a>
    </li>
    <li>
      <a href="../articles/data-transformation.html">Data Transformation</a>
    </li>
    <li>
      <a href="../articles/frailty.html">Frailty and random effects</a>
    </li>
    <li>
      <a href="../articles/splines.html">Splines</a>
    </li>
    <li>
      <a href="../articles/strata.html">Stratified baseline</a>
    </li>
    <li>
      <a href="../articles/tdcovar.html">Time-dependent covariates</a>
    </li>
    <li>
      <a href="../articles/tveffects.html">Time-varying effects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/adibender/pammtools">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Data Transformation</h1>
                        <h4 class="author">Andreas Bender</h4>
            
            <h4 class="date">2017-11-14</h4>
          </div>

    
    
<div class="contents">
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(pammtools)</code></pre></div>
<p>In this vignette we provide details on transforming data into a format suitable to fit piece-wise exponential (additive) models (PAM). Three main cases need to be distinguished</p>
<ol style="list-style-type: decimal">
<li><p>Data without time-dependent covariates</p></li>
<li><p>Data with time-dependent covariates</p></li>
<li><p>Data with time-dependent covariates that should be modeled as cumulative effects</p></li>
</ol>
<div id="data-without-time-dependent-covariates" class="section level2">
<h2 class="hasAnchor">
<a href="#data-without-time-dependent-covariates" class="anchor"></a>Data without time-dependent covariates</h2>
<p>In this simple case the data transformation is relatively straight forward and handeled by the <code>split_data</code> function. This function internally calls <code><a href="http://www.rdocumentation.org/packages/survival/topics/survSplit">survival::survSplit</a></code>, thus all arguments available for the <code>survSplit</code> function are also available to the <code>split_data</code> function.</p>
<div id="using-defaults" class="section level3">
<h3 class="hasAnchor">
<a href="#using-defaults" class="anchor"></a>Using defaults</h3>
<p>As an example data set we first consider Veterans’ Administration lung cancer study <span class="citation">(Kalbfleisch and Prentice 1980)</span> available from the <code>survival</code> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">"veteran"</span>, <span class="dt">package =</span> <span class="st">"survival"</span>)
veteran &lt;-<span class="st"> </span>veteran %&gt;%
<span class="st">  </span><span class="kw"><a href="../reference/dplyr_verbs.html">mutate</a></span>(
    <span class="dt">id    =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/ranking">row_number</a></span>(),
    <span class="dt">trt   =</span> <span class="dv">1</span>*(trt ==<span class="st"> </span><span class="dv">2</span>),
    <span class="dt">prior =</span> <span class="dv">1</span>*(prior !=<span class="st"> </span><span class="dv">0</span>)) %&gt;%
<span class="st">  </span><span class="kw"><a href="../reference/dplyr_verbs.html">select</a></span>(id,<span class="kw"><a href="http://www.rdocumentation.org/packages/dplyr/topics/select_helpers">everything</a></span>())
<span class="kw">head</span>(veteran)</code></pre></div>
<pre><code>##   id trt celltype time status karno diagtime age prior
## 1  1   0 squamous   72      1    60        7  69     0
## 2  2   0 squamous  411      1    70        5  64     1
## 3  3   0 squamous  228      1    60        3  38     0
## 4  4   0 squamous  126      1    60        9  63     1
## 5  5   0 squamous  118      1    70       11  65     1
## 6  6   0 squamous   10      1    20        5  49     0</code></pre>
<p>Each row contains information on the survival time (<code>time</code>), an event indicator (<code>status</code>) and the <code>treatment</code> information (<code>6-MP</code> vs. <code>placebo</code>) as the only covariate.</p>
<p>To transform the data into piece-wise exponential data (<code>ped</code>) format, we need to</p>
<ul>
<li><p>define <span class="math inline">\(J+1\)</span> interval break points <span class="math inline">\(t_{\min} = \kappa_0 &lt; \kappa_1 &lt; \cdots &lt; \kappa_J = t_{\max}\)</span></p></li>
<li><p>create <em>pseudo</em>-observations for each interval <span class="math inline">\(j = 1,\ldots, J\)</span> in which subject <span class="math inline">\(i, i = 1,\ldots,n\)</span> was under risk.</p></li>
</ul>
<p>Using the <code>pammtools</code> package this is easily achieved with the <code>split_data</code> function as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ped &lt;-<span class="st"> </span><span class="kw"><a href="../reference/split_data.html">split_data</a></span>(<span class="kw">Surv</span>(time, status)~., <span class="dt">data =</span> veteran, <span class="dt">id =</span> <span class="st">"id"</span>)
ped %&gt;%<span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">filter</a></span>(id %in%<span class="st"> </span><span class="kw">c</span>(<span class="dv">42</span>, <span class="dv">85</span>, <span class="dv">112</span>)) %&gt;%<span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">select</a></span>(-diagtime, -prior)</code></pre></div>
<pre><code>##     id tstart tend interval    offset ped_status trt  celltype karno age
## 1   42      0    1    (0,1] 0.0000000          0   0 smallcell    50  72
## 2   42      1    2    (1,2] 0.0000000          0   0 smallcell    50  72
## 3   42      2    3    (2,3] 0.0000000          0   0 smallcell    50  72
## 4   42      3    4    (3,4] 0.0000000          0   0 smallcell    50  72
## 5   42      4    7    (4,7] 1.0986123          1   0 smallcell    50  72
## 6   85      0    1    (0,1] 0.0000000          1   1  squamous    50  35
## 7  112      0    1    (0,1] 0.0000000          0   1     adeno    60  62
## 8  112      1    2    (1,2] 0.0000000          0   1     adeno    60  62
## 9  112      2    3    (2,3] 0.0000000          0   1     adeno    60  62
## 10 112      3    4    (3,4] 0.0000000          0   1     adeno    60  62
## 11 112      4    7    (4,7] 1.0986123          0   1     adeno    60  62
## 12 112      7    8    (7,8] 0.0000000          0   1     adeno    60  62
## 13 112      8   10   (8,10] 0.6931472          0   1     adeno    60  62
## 14 112     10   11  (10,11] 0.0000000          0   1     adeno    60  62
## 15 112     11   12  (11,12] 0.0000000          0   1     adeno    60  62
## 16 112     12   13  (12,13] 0.0000000          0   1     adeno    60  62
## 17 112     13   15  (13,15] 0.6931472          0   1     adeno    60  62
## 18 112     15   16  (15,16] 0.0000000          0   1     adeno    60  62
## 19 112     16   18  (16,18] 0.6931472          0   1     adeno    60  62
## 20 112     18   19  (18,19] 0.0000000          0   1     adeno    60  62
## 21 112     19   20  (19,20] 0.0000000          0   1     adeno    60  62
## 22 112     20   21  (20,21] 0.0000000          0   1     adeno    60  62
## 23 112     21   22  (21,22] 0.0000000          0   1     adeno    60  62
## 24 112     22   24  (22,24] 0.6931472          0   1     adeno    60  62
## 25 112     24   25  (24,25] 0.0000000          0   1     adeno    60  62
## 26 112     25   27  (25,27] 0.6931472          0   1     adeno    60  62
## 27 112     27   29  (27,29] 0.6931472          0   1     adeno    60  62
## 28 112     29   30  (29,30] 0.0000000          0   1     adeno    60  62
## 29 112     30   31  (30,31] 0.0000000          0   1     adeno    60  62
## 30 112     31   33  (31,33] 0.6931472          0   1     adeno    60  62
## 31 112     33   35  (33,35] 0.6931472          0   1     adeno    60  62
## 32 112     35   36  (35,36] 0.0000000          0   1     adeno    60  62
## 33 112     36   42  (36,42] 1.7917595          0   1     adeno    60  62
## 34 112     42   43  (42,43] 0.0000000          0   1     adeno    60  62
## 35 112     43   44  (43,44] 0.0000000          0   1     adeno    60  62
## 36 112     44   45  (44,45] 0.0000000          0   1     adeno    60  62
## 37 112     45   48  (45,48] 1.0986123          0   1     adeno    60  62
## 38 112     48   49  (48,49] 0.0000000          0   1     adeno    60  62
## 39 112     49   51  (49,51] 0.6931472          1   1     adeno    60  62</code></pre>
<p>When no cut points are specified, the default is to use the unique event times. As can be seen from the above output, the function creates an <code>id</code> variable, indicating the subjects <span class="math inline">\(i = 1,\ldots,n\)</span>, with one row per <code>id</code> for each interval the subject “visited”. Thus,</p>
<ul>
<li>subject <code>42</code> was under risk during 5 intervals,</li>
<li>subject <code>85</code> was under risk during one interval,</li>
<li>and subject <code>112</code> in 33 intervals.</li>
</ul>
<p>In addition to the optional <code>id</code> variable the function also creates</p>
<ul>
<li>
<code>tstart</code>: the beginning of each interval</li>
<li>
<code>tend</code>: the end of each interval</li>
<li>
<code>interval</code>: a factor variable denoting the interval</li>
<li>
<code>offset</code>: the log of the duration during which the subject was under risk in that interval</li>
</ul>
<p>Additionally the time-constant covariates (here: <code>trt</code>, <code>celltype</code>, <code>karno</code>, etc.) are repeated <span class="math inline">\(n_i\)</span> number of times, where <span class="math inline">\(n_i\)</span> is the number of intervals during which subject <span class="math inline">\(i\)</span> was in the risk set.</p>
</div>
<div id="custom-cut-points" class="section level3">
<h3 class="hasAnchor">
<a href="#custom-cut-points" class="anchor"></a>Custom cut points</h3>
<p>Per default the <code>split_data</code> function uses all unique event times as cut points (which is a sensible default as for example the (cumulative) baseline hazard estimates in Cox-PH functions are updated also only at event times).</p>
<p>In some cases, however, one might want to reduce the number of cut points, to reduce the size of the resulting data object and/or faster estimation times. To do so the <code>cut</code> argument has to be specified. Following the above example, we can use only 4 cut points <span class="math inline">\(\kappa_0 = 0, \kappa_1 = 50, \kappa_2 = 200, \kappa_3 = 400\)</span>, resulting in <span class="math inline">\(J = 3\)</span> intervals:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ped2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/split_data.html">split_data</a></span>(<span class="kw">Surv</span>(time, status)~., <span class="dt">data =</span> veteran, <span class="dt">cut =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">200</span>, <span class="dv">400</span>),
  <span class="dt">id =</span> <span class="st">"id"</span>)
ped2 %&gt;%<span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">filter</a></span>(id %in%<span class="st"> </span><span class="kw">c</span>(<span class="dv">42</span>, <span class="dv">85</span>, <span class="dv">112</span>)) %&gt;%<span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">select</a></span>(-diagtime, -prior)</code></pre></div>
<pre><code>##    id tstart tend interval   offset ped_status trt  celltype karno age
## 1  42      0   50   (0,50] 1.945910          1   0 smallcell    50  72
## 2  85      0   50   (0,50] 0.000000          1   1  squamous    50  35
## 3 112      0   50   (0,50] 3.912023          0   1     adeno    60  62
## 4 112     50  200 (50,200] 0.000000          1   1     adeno    60  62</code></pre>
<p>Note that now subjects <code>42</code> and <code>85</code> have only one row in the data set. The fact that subjects <code>42</code> was in the risk set longer than subject <code>85</code> is, however, still accounted for by the <code>offset</code> variable. Note that the <code>offset</code>s for subject <code>85</code> and subject <code>112</code> in interval <code>(50,200]</code> are only zero because subject <code>85</code> had an observed event time of <code>1</code>, thus <code>log(1-0)=0</code> and subject <code>112</code> had an event at time <code>51</code>, thus <code>log(51-50)=0</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">veteran %&gt;%<span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">slice</a></span>(<span class="kw">c</span>(<span class="dv">85</span>, <span class="dv">112</span>))</code></pre></div>
<pre><code>## # A tibble: 2 x 9
##      id   trt celltype  time status karno diagtime   age prior
##   &lt;int&gt; &lt;dbl&gt; &lt;fctr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1    85  1.00 squamous  1.00   1.00  50.0     7.00  35.0     0
## 2   112  1.00 adeno    51.0    1.00  60.0     5.00  62.0     0</code></pre>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Kalbfleisch1980">
<p>Kalbfleisch, J., and R. Prentice. 1980. <em>The Statistical Analysis of Failure Time Data</em>. New York: Wiley.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#data-without-time-dependent-covariates">Data without time-dependent covariates</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Andreas Bender, Fabian Scheipl.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
